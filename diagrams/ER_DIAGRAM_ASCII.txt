╔═══════════════════════════════════════════════════════════════════════════════════════════════╗
║                          ER-ДИАГРАММА БД АСУ ТП (АО "НИКИЭТ")                                 ║
╚═══════════════════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ЦЕНТРАЛЬНЫЙ УЗЕЛ                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

                                 ┌──────────────────────────┐
                                 │  tech_params.parameters  │
                                 ├──────────────────────────┤
                                 │ • id (PK)                │
                                 │ • group_id (FK)          │
                                 │ • tag (UNIQUE)           │
                                 │ • name                   │
                                 │ • parameter_type         │
                                 │ • unit_id (FK) ────────┐ │
                                 │ • alarm_low             │ │
                                 │ • alarm_high            │ │
                                 │ • is_active             │ │
                                 └──────────┬───────────────┘ │
                                            │                 │
                    ┌───────────────────────┼─────────────────┼─────────────────────┐
                    │                       │                 │                     │
                    ▼                       ▼                 ▼                     ▼
                                                                              
        ┌──────────────────────┐   ┌──────────────────┐   ┌─────────────┐   ┌──────────────────┐
        │ tech_params.         │   │ archive.         │   │ core.units  │   │ controllers.     │
        │ current_values       │   │ historical_data  │   ├─────────────┤   │ io_channels      │
        ├──────────────────────┤   ├──────────────────┤   │ • id (PK)   │   ├──────────────────┤
        │ • parameter_id (PK,FK│   │ • id (PK)        │   │ • code      │   │ • id (PK)        │
        │ • value              │   │ • parameter_id FK│   │ • name      │   │ • module_id      │
        │ • quality            │   │ • timestamp      │   │ • symbol    │   │ • parameter_id FK│
        │ • timestamp          │   │ • value          │   │ • unit_type │   │ • channel_type   │
        └──────────────────────┘   │ • quality        │   └─────────────┘   └──────────────────┘
                                   └──────────────────┘
                    │                       │                                       │
                    │                       │                                       │
                    ▼                       ▼                                       ▼
                                                                              
        ┌──────────────────────┐   ┌──────────────────┐                 ┌──────────────────┐
        │ algorithms.          │   │ visualization.   │                 │ events.events    │
        │ algorithm_inputs     │   │ screen_elements  │                 ├──────────────────┤
        ├──────────────────────┤   ├──────────────────┤                 │ • id (PK)        │
        │ • id (PK)            │   │ • id (PK)        │                 │ • source_type    │
        │ • algorithm_id (FK)  │   │ • screen_id (FK) │                 │ • source_id      │
        │ • parameter_id (FK) ─┘   │ • parameter_id FK│                 │ • event_time     │
        └──────────────────────┘   │ • element_type   │                 │ • is_acknowledged│
                                   └──────────────────┘                 └──────────────────┘
        ┌──────────────────────┐
        │ algorithms.          │
        │ algorithm_outputs    │
        ├──────────────────────┤
        │ • id (PK)            │
        │ • algorithm_id (FK)  │
        │ • parameter_id (FK) ─┘
        └──────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                 БЕЗОПАСНОСТЬ И РОЛИ                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

        ┌──────────────────┐         ┌──────────────────┐         ┌─────────────────┐
        │ security.users   │         │ security.        │         │ security.       │
        │                  │         │ user_roles       │         │ roles           │
        ├──────────────────┤         ├──────────────────┤         ├─────────────────┤
        │ • id (PK)        │◄────────│ • id (PK)        │────────►│ • id (PK)       │
        │ • username       │         │ • user_id (FK)   │         │ • code          │
        │ • password_hash  │         │ • role_id (FK)   │         │ • name          │
        │ • full_name      │         └──────────────────┘         │ • priority      │
        │ • is_active      │                 │                    └────────┬────────┘
        └──────────────────┘                 │                             │
                 │                           │                             │
                 │                           │                             ▼
                 ▼                           ▼                    ┌─────────────────┐
        ┌──────────────────┐         ┌──────────────────┐        │ security.       │
        │ security.        │         │ security.        │        │ role_permissions│
        │ user_sessions    │         │ audit_log        │        ├─────────────────┤
        ├──────────────────┤         ├──────────────────┤        │ • role_id (FK)  │
        │ • id (PK)        │         │ • id (PK)        │        │ • permission_id │
        │ • user_id (FK) ──┘         │ • user_id (FK) ──┘        └────────┬────────┘
        │ • token_hash     │         │ • action_type    │                 │
        │ • is_active      │         │ • object_type    │                 ▼
        └──────────────────┘         │ • success        │        ┌─────────────────┐
                                     └──────────────────┘        │ security.       │
                                                                 │ permissions     │
                                                                 ├─────────────────┤
                                                                 │ • id (PK)       │
                                                                 │ • code          │
                                                                 │ • resource      │
                                                                 │ • action        │
                                                                 └─────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                         ДОПОЛНИТЕЛЬНЫЕ СХЕМЫ                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ topology.nodes  │   │ kross.modules   │   │ reports.        │   │ controllers.    │
│                 │   │                 │   │ report_templates│   │ controllers     │
├─────────────────┤   ├─────────────────┤   ├─────────────────┤   ├─────────────────┤
│ • id (PK)       │   │ • id (PK)       │   │ • id (PK)       │   │ • id (PK)       │
│ • parent_id     │   │ • code          │   │ • code          │   │ • type_id (FK)  │
│ • node_type_id  │   │ • is_enabled    │   │ • category      │   │ • node_id (FK)  │
│ • is_online     │   │ • start_order   │   │ • report_type   │   │ • status_id     │
└─────────────────┘   └─────────────────┘   └─────────────────┘   └─────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════════

СТАТИСТИКА:
• 11 схем
• 50+ таблиц
• 200+ индексов (GIN, BRIN, B-Tree, pg_trgm)
• 6 ролей (admin, engineer, senior_operator, operator, viewer, service)
• 25+ разрешений
• 30+ функций
• 20+ триггеров

КЛЮЧЕВЫЕ ОСОБЕННОСТИ:
• Партиционирование archive.historical_data по времени
• RLS на security.users и security.object_permissions
• Advisory locks для единовременного доступа
• Полнотекстовый поиск (tsvector)
• Аудит всех действий
• Автоматические временные метки (триггеры)
• Проверка аварийных уставок (триггеры)

═══════════════════════════════════════════════════════════════════════════════════════════════
Конфиденциально. АО "НИКИЭТ". ГОСТ Р ИСО 9001-2015.
═══════════════════════════════════════════════════════════════════════════════════════════════

