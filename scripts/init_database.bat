@echo off
REM ==============================================================================
REM Скрипт инициализации базы данных ПТК АСУ ТП
REM Для Windows
REM ==============================================================================

echo ================================================================================
echo   ИНИЦИАЛИЗАЦИЯ БАЗЫ ДАННЫХ ПТК АСУ ТП
echo   Платформа: КРОСС
echo   СУБД: PostgreSQL 15+
echo ================================================================================
echo.

REM Настройки подключения
set PGHOST=localhost
set PGPORT=5432
set PGUSER=postgres
set PGDATABASE=postgres

echo Настройки подключения:
echo   Сервер: %PGHOST%:%PGPORT%
echo   Пользователь: %PGUSER%
echo.

REM Проверка наличия psql
where psql >nul 2>&1
if %errorlevel% neq 0 (
    echo ОШИБКА: PostgreSQL клиент (psql) не найден!
    echo Убедитесь, что PostgreSQL установлен и добавлен в PATH
    pause
    exit /b 1
)

echo Проверка подключения к PostgreSQL...
psql -c "SELECT version();" >nul 2>&1
if %errorlevel% neq 0 (
    echo ОШИБКА: Не удается подключиться к PostgreSQL!
    echo Проверьте, что сервер запущен и настройки подключения верны
    pause
    exit /b 1
)

echo.
echo ВНИМАНИЕ! Этот скрипт создаст новую базу данных asu_tp_db
echo Если база данных уже существует, она будет УДАЛЕНА!
echo.
set /p confirm="Продолжить? (Y/N): "
if /i "%confirm%" neq "Y" (
    echo Отменено пользователем
    exit /b 0
)

echo.
echo ================================================================================
echo Шаг 1/8: Создание базы данных...
echo ================================================================================
psql -f ../sql/01_create_database.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo Шаг 2/8: Создание схем...
echo ================================================================================
psql -d asu_tp_db -f ../sql/02_create_schemas.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo Шаг 3/8: Создание таблиц...
echo ================================================================================
psql -d asu_tp_db -f ../sql/03_create_tables.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo Шаг 4/8: Создание индексов...
echo ================================================================================
psql -d asu_tp_db -f ../sql/04_create_indexes.sql
if %errorlevel% neq 0 (
    echo Файл индексов не найден, пропускаем...
)

echo.
echo ================================================================================
echo Шаг 5/8: Создание ролей и прав доступа...
echo ================================================================================
psql -d asu_tp_db -f ../sql/05_create_roles.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo Шаг 6/8: Создание функций...
echo ================================================================================
psql -d asu_tp_db -f ../sql/06_create_functions.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo Шаг 7/8: Создание триггеров...
echo ================================================================================
psql -d asu_tp_db -f ../sql/07_create_triggers.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo Шаг 8/8: Загрузка начальных данных...
echo ================================================================================
psql -d asu_tp_db -f ../sql/08_initial_data.sql
if %errorlevel% neq 0 goto :error

echo.
echo ================================================================================
echo   ИНИЦИАЛИЗАЦИЯ ЗАВЕРШЕНА УСПЕШНО!
echo ================================================================================
echo.
echo Информация о базе данных:
echo   База данных: asu_tp_db
echo   Схемы: core, tech_params, controllers, archive, algorithms, 
echo          visualization, topology, kross, security, events, reports
echo.
echo Пользователи по умолчанию:
echo   admin / AdminPassword123!    (Администратор)
echo   engineer / Test123!          (Инженер)
echo   operator1 / Test123!         (Оператор)
echo   operator2 / Test123!         (Оператор)
echo   viewer / Test123!            (Наблюдатель)
echo.
echo ВАЖНО: Обязательно смените пароли по умолчанию!
echo.
echo Для проверки подключения выполните:
echo   psql -d asu_tp_db -U postgres
echo.
pause
exit /b 0

:error
echo.
echo ================================================================================
echo   ОШИБКА ПРИ ИНИЦИАЛИЗАЦИИ!
echo ================================================================================
echo Проверьте логи выше для определения причины ошибки
echo.
pause
exit /b 1



