# 📊 Схема развертывания БД АСУ ТП

## 🔄 Процесс развертывания

```
┌─────────────────────────────────────────────────────────────────┐
│                    НАЧАЛО РАЗВЕРТЫВАНИЯ                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
                    ┌─────────┐
                    │ Выбор   │
                    │ варианта│
                    └────┬────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
    ┌─────────┐                    ┌──────────┐
    │ Docker  │                    │ Локально │
    │ 🐳      │                    │ 💻       │
    └────┬────┘                    └────┬─────┘
         │                               │
         ▼                               ▼
    ┌─────────────────┐          ┌────────────────┐
    │START_DOCKER.bat │          │START_LOCAL.bat │
    └────┬────────────┘          └────┬───────────┘
         │                               │
         ▼                               ▼
    ┌─────────────────┐          ┌────────────────┐
    │ Docker Desktop  │          │ PostgreSQL 15+ │
    │ проверка        │          │ проверка       │
    └────┬────────────┘          └────┬───────────┘
         │                               │
         ▼                               ▼
    ┌─────────────────┐          ┌────────────────┐
    │ .env файл       │          │ Ввод пароля    │
    │ создание        │          │ postgres       │
    └────┬────────────┘          └────┬───────────┘
         │                               │
         ▼                               │
    ┌─────────────────┐                 │
    │ docker-compose  │                 │
    │ up -d           │                 │
    └────┬────────────┘                 │
         │                               │
         ├───────────────────────────────┤
         │                               │
         ▼                               ▼
┌────────────────────────────────────────────────────────────┐
│              ВЫПОЛНЕНИЕ SQL СКРИПТОВ (01-08)               │
│                                                            │
│  01_create_database.sql   ┌──────────────────┐           │
│  ├─ Создание БД           │ asu_tp_db        │           │
│  ├─ Расширения            │ uuid-ossp        │           │
│  └─ Настройки             │ pgcrypto         │           │
│                           └──────────────────┘           │
│                                  │                        │
│  02_create_schemas.sql          ▼                        │
│  ├─ core                ┌──────────────────┐            │
│  ├─ tech_params         │ 11 схем          │            │
│  ├─ controllers         │ созданы          │            │
│  └─ ... (еще 8)         └──────────────────┘            │
│                                  │                        │
│  03_create_tables.sql           ▼                        │
│  ├─ parameters          ┌──────────────────┐            │
│  ├─ controllers         │ 50+ таблиц       │            │
│  ├─ users               │ созданы          │            │
│  └─ ... (еще 47)        └──────────────────┘            │
│                                  │                        │
│  04_create_indexes.sql          ▼                        │
│  ├─ idx_parameters_tag  ┌──────────────────┐            │
│  ├─ idx_events_time     │ 200+ индексов    │            │
│  └─ ... (еще 198)       │ созданы          │            │
│                         └──────────────────┘            │
│                                  │                        │
│  05_create_roles.sql            ▼                        │
│  ├─ admin               ┌──────────────────┐            │
│  ├─ engineer            │ 6 ролей          │            │
│  ├─ operator            │ созданы          │            │
│  └─ ... (еще 3)         └──────────────────┘            │
│                                  │                        │
│  06_create_functions.sql        ▼                        │
│  ├─ acquire_lock()      ┌──────────────────┐            │
│  ├─ check_permission()  │ Функции          │            │
│  └─ ...                 │ созданы          │            │
│                         └──────────────────┘            │
│                                  │                        │
│  07_create_triggers.sql         ▼                        │
│  ├─ trg_parameters      ┌──────────────────┐            │
│  ├─ trg_users           │ Триггеры         │            │
│  └─ ...                 │ созданы          │            │
│                         └──────────────────┘            │
│                                  │                        │
│  08_initial_data.sql            ▼                        │
│  ├─ Единицы измерения   ┌──────────────────┐            │
│  ├─ Типы данных         │ Справочники      │            │
│  └─ Статусы             │ загружены        │            │
│                         └──────────────────┘            │
└────────────────────────────┬───────────────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ ✅ РАЗВЕРТЫВАНИЕ│
                    │    ЗАВЕРШЕНО!   │
                    └────┬────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
    ┌─────────────┐              ┌─────────────┐
    │ PostgreSQL  │              │ pgAdmin     │
    │ localhost   │              │ localhost   │
    │ :5432       │              │ :5050       │
    └─────────────┘              └─────────────┘
         │                               │
         │                               ▼
         │                        ┌─────────────┐
         │                        │ Grafana     │
         │                        │ localhost   │
         │                        │ :3000       │
         │                        └─────────────┘
         │
         ▼
    ┌─────────────────────────────────────┐
    │ ПРОВЕРКА: CHECK_STATUS.bat          │
    └─────────────────────────────────────┘
```

---

## 🗂️ Структура данных после развертывания

```
┌──────────────────────────────────────────────────────────────┐
│                      asu_tp_db                                │
└──────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
  ┌──────────┐        ┌──────────┐       ┌──────────┐
  │   core   │        │tech_params│      │controllers│
  │  (база)  │        │(параметры)│      │ (КУПРИ)  │
  └────┬─────┘        └────┬─────┘       └────┬─────┘
       │                   │                   │
       ├─ units            ├─ parameters       ├─ controllers
       ├─ data_types       ├─ current_values   ├─ modules
       └─ statuses         └─ groups           └─ io_channels
       
        ▼                   ▼                   ▼
  ┌──────────┐        ┌──────────┐       ┌──────────┐
  │ archive  │        │algorithms│       │visualization│
  │ (архив)  │        │(расчеты) │       │ (мнемо)  │
  └────┬─────┘        └────┬─────┘       └────┬─────┘
       │                   │                   │
       ├─ historical       ├─ algorithms       ├─ screens
       ├─ compressed       ├─ inputs           ├─ elements
       └─ configs          └─ outputs          └─ templates
       
        ▼                   ▼                   ▼
  ┌──────────┐        ┌──────────┐       ┌──────────┐
  │ topology │        │  kross   │       │ security │
  │ (топол.) │        │(платф.)  │       │(безопас.)│
  └────┬─────┘        └────┬─────┘       └────┬─────┘
       │                   │                   │
       ├─ nodes            ├─ config           ├─ users
       ├─ types            ├─ modules          ├─ roles
       └─ connections      └─ licenses         └─ permissions
       
        ▼                   ▼
  ┌──────────┐        ┌──────────┐
  │  events  │        │ reports  │
  │ (тревоги)│        │(отчеты)  │
  └────┬─────┘        └────┬─────┘
       │                   │
       ├─ events           ├─ templates
       ├─ classes          ├─ schedules
       └─ subscriptions    └─ history
```

---

## 🔐 Ролевая модель

```
┌─────────────────────────────────────────────────────────┐
│                    ИЕРАРХИЯ РОЛЕЙ                        │
└─────────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────┐
    │        ADMIN (Приоритет: 1000)         │
    │    Полный доступ ко всем ресурсам      │
    └──────────────────┬─────────────────────┘
                       │
         ┌─────────────┼─────────────┐
         ▼             ▼             ▼
    ┌─────────┐  ┌──────────┐  ┌─────────┐
    │ENGINEER │  │  SENIOR  │  │ SERVICE │
    │  (800)  │  │ OPERATOR │  │  (100)  │
    │         │  │  (600)   │  │         │
    │Настройка│  │Управление│  │Внешние  │
    │системы  │  │+ квитир. │  │системы  │
    └─────────┘  └────┬─────┘  └─────────┘
                      │
                      ▼
                 ┌─────────┐
                 │OPERATOR │
                 │  (400)  │
                 │         │
                 │Мониторинг
                 │управление│
                 └────┬────┘
                      │
                      ▼
                 ┌─────────┐
                 │ VIEWER  │
                 │  (200)  │
                 │         │
                 │Просмотр │
                 │данных   │
                 └─────────┘

Права наследуются сверху вниз
```

---

## 🔄 Процесс работы с данными

```
┌──────────────────────────────────────────────────────────┐
│              ЖИЗНЕННЫЙ ЦИКЛ ДАННЫХ                        │
└──────────────────────────────────────────────────────────┘

1. СБОР ДАННЫХ
   ┌─────────────┐
   │ Контроллеры │──┐
   │   КУПРИ     │  │
   └─────────────┘  │
                    ├──► ┌──────────────────┐
   ┌─────────────┐  │    │ tech_params.     │
   │  OPC UA     │──┤    │ current_values   │
   └─────────────┘  │    └────────┬─────────┘
                    │             │
   ┌─────────────┐  │             ▼
   │  Modbus     │──┘    ┌──────────────────┐
   └─────────────┘       │ Проверка уставок │
                         │ (триггеры)       │
                         └────────┬─────────┘
                                  │
2. ОБРАБОТКА                      ▼
   ┌─────────────────────────────────┐
   │ Расчетные алгоритмы             │
   │ (algorithms.algorithms)          │
   └────────┬────────────────────────┘
            │
            ▼
   ┌─────────────────────────────────┐
   │ Генерация событий при отклонениях│
   │ (events.events)                  │
   └────────┬────────────────────────┘
            │
3. АРХИВАЦИЯ                     ▼
   ┌─────────────────────────────────┐
   │ Сохранение в архив              │
   │ (archive.historical_data)        │
   └────────┬────────────────────────┘
            │
            ├──► Партиционирование по времени
            │
            ▼
   ┌─────────────────────────────────┐
   │ Сжатие старых данных            │
   │ (archive.compressed_data)        │
   └────────┬────────────────────────┘
            │
4. ВИЗУАЛИЗАЦИЯ              ▼
   ┌─────────────────────────────────┐
   │ Отображение на мнемосхемах      │
   │ (visualization.screens)          │
   └────────┬────────────────────────┘
            │
            ▼
   ┌─────────────────────────────────┐
   │ Формирование отчетов            │
   │ (reports)                        │
   └─────────────────────────────────┘
```

---

## 📊 Статистика после развертывания

```
╔═══════════════════════════════════════════════════════╗
║              ИТОГОВАЯ СТАТИСТИКА БД                   ║
╠═══════════════════════════════════════════════════════╣
║ Схем:                              11                 ║
║ Таблиц:                           50+                 ║
║ Индексов:                        200+                 ║
║ Функций:                          30+                 ║
║ Триггеров:                        20+                 ║
║ Ролей PostgreSQL:                  5                  ║
║ Ролей приложения:                  6                  ║
║ Разрешений:                       25+                 ║
║ Пользователей (начальных):         1                  ║
╠═══════════════════════════════════════════════════════╣
║ Размер БД (пустой):           ~50 MB                  ║
║ Размер БД (с данными):        ~500 MB - 5 GB          ║
║ Макс. подключений:              200                   ║
║ Рекомендуемая RAM:              16 GB                 ║
║ Рекомендуемый CPU:            4+ ядер                 ║
╚═══════════════════════════════════════════════════════╝
```

---

## 🎯 Следующие шаги после развертывания

```
1. ✅ РАЗВЕРТЫВАНИЕ ЗАВЕРШЕНО
   │
   ▼
2. 🔒 НАСТРОЙКА БЕЗОПАСНОСТИ
   ├─ Смена паролей по умолчанию
   ├─ Настройка SSL/TLS
   ├─ Настройка firewall
   └─ Создание пользователей
   │
   ▼
3. 📊 НАСТРОЙКА МОНИТОРИНГА
   ├─ Подключение к Grafana
   ├─ Настройка дашбордов
   └─ Настройка алертов
   │
   ▼
4. 🔄 НАСТРОЙКА РЕЗЕРВНОГО КОПИРОВАНИЯ
   ├─ Настройка расписания
   ├─ Настройка хранения
   └─ Тестирование восстановления
   │
   ▼
5. 🔌 ИНТЕГРАЦИЯ С КРОСС
   ├─ Настройка подключения
   ├─ Импорт параметров
   └─ Тестирование
   │
   ▼
6. 🚀 НАЧАЛО ЭКСПЛУАТАЦИИ
```

---

<div align="center">

**Визуализация процесса развертывания**

Создано для АО "НИКИЭТ" | Платформа КРОСС

</div>

